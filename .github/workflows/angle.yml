name: ANGLE DLLs
on:
  push:
    branches:
      - master
      - angle-or-devil

env:
  ANGLE_VERSION: 4484

jobs:
  angle-build:
    name: ${{ matrix.name }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { name: "Windows", os: "windows-2019", arch: "x86" }
          - { name: "Windows", os: "windows-2019", arch: "x64" }
          - { name: "macOS", os: "macos-10.15", arch: "x64" }
          - { name: "macOS", os: "macos-10.15", arch: "arm64" }
    steps:
    - name: Clone ANGLE
      run: |
        git clone https://github.com/google/angle.git
      env:
        DEPOT_TOOLS_WIN_TOOLCHAIN: 0

    - name: Fetch Cached third_party
      id: thirdparty-cache
      uses: actions/cache@v2
      with:
        path: angle/third_party/
        key: thirdparty-${{ env.ANGLE_VERSION }}-${{ matrix.os }}

    - name: Fetch Cached angle/tools
      id: angletools-cache
      uses: actions/cache@v2
      with:
        path: angle/tools/
        key: tools-${{ env.ANGLE_VERSION }}-${{ matrix.os }}

    - name: Fetch Cached depot_tools
      id: depot-tools-cache
      uses: actions/cache@v2
      with:
        path: angle/tools/
        key: tools-${{ env.ANGLE_VERSION }}-${{ matrix.os }}

    - name: Install Depot Tools (Windows)
      if: steps.depot-tools-cache.outputs.cache-hit != true
      run: >
        Invoke-WebRequest -Uri "https://storage.googleapis.com/chrome-infra/depot_tools.zip" -OutFile depot_tools.zip
        Expand-Archive -Path depot_tools.zip -DestinationPath depot_tools
        Remove-Item depot_tools.zip

    - name: Install Depot Tools (Mac)
      if: steps.depot-tools-cache.outputs.cache-hit != true
      run: >
        Invoke-WebRequest -Uri "https://storage.googleapis.com/chrome-infra/depot_tools.zip" -OutFile depot_tools.zip
        Expand-Archive -Path depot_tools.zip -DestinationPath depot_tools
        Remove-Item depot_tools.zip

    - name: Build ANGLE
      run: |
        echo "$pwd\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        cd angle
        python ./scripts/bootstrap.py
        gclient sync
        git checkout chromium/${{ env.ANGLE_VERSION }}
        gn gen out/${{ matrix.arch }} --args='is_debug=false dcheck_always_on=false target_cpu=\"${{ matrix.arch }}\"'
        ninja -C out/x64 libEGL libGLESv2
      env:
        DEPOT_TOOLS_WIN_TOOLCHAIN: 0
